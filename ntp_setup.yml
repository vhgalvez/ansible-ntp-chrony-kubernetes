---
- name: Configurar NTP en el Servidor FreeIPA
  hosts: freeipa_servers
  become: yes
  gather_facts: no  # Desactiva la recopilación de datos para evitar el requisito de Python

  tasks:
    - name: Verificar sistema operativo en FreeIPA para asegurarse de que es compatible
      ansible.builtin.raw: "hostnamectl"
      register: os_check
      ignore_errors: true

    - name: Mostrar información de sistema operativo (para depuración)
      debug:
        var: os_check.stdout

    - name: Instalar chrony en FreeIPA (Servidor NTP) si es Rocky Linux
      ansible.builtin.raw: "dnf install -y chrony"
      when: "'Rocky Linux' in os_check.stdout"

    - name: Configurar chrony en FreeIPA
      ansible.builtin.raw: |
        echo 'pool europe.pool.ntp.org iburst
        server 10.17.3.11 iburst prefer' > /etc/chrony.conf

    - name: Iniciar y habilitar chronyd en FreeIPA
      ansible.builtin.raw: |
        systemctl enable chronyd --now
        systemctl start chronyd

    - name: Abrir puerto NTP en el firewall de FreeIPA
      ansible.builtin.raw: |
        firewall-cmd --permanent --add-service=ntp
        firewall-cmd --reload